<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Jellyfin Tweaks</title>
</head>
<body>
<div class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-checkbox" data-role="page" id="JellyTweaksPage">
    <div data-role="content">
        <div class="content-primary">
            <div class="verticalSection">
                <div class="sectionTitleContainer">
                    <h2 class="sectionTitle">Jellyfin Tweaks</h2>
                    <a is="emby-linkbutton" class="raised raised-mini emby-button" style="margin-left: 2em;"
                        target="_blank" href="https://github.com/n00bcodr/JellyfinTweaks">
                        <i class="md-icon button-icon button-icon-left secondaryText"></i>
                        <span>Help</span>
                    </a>
                </div>
            </div>
            <hr>
            <br/>

            <form id="JellyTweaksForm">
                <!-- Input for DefaultLibraryPageSize -->
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="DefaultLibraryPageSize">Default Library Page Size</label>
                    <input id="DefaultLibraryPageSize" is="emby-input" min="0" name="DefaultLibraryPageSize" type="number"/>
                    <div class="fieldDescription">Override the amount of items to show on a library page. Set to 0 in order to disable paging.</div>
                </div>
                <!-- Input for MaxDaysNextUp -->
                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="MaxDaysNextUp">Max Days in 'Next Up'</label>
                    <input id="MaxDaysNextUp" is="emby-input" min="0" name="MaxDaysNextUp" type="number" />
                    <div class="fieldDescription">Default value is 365. Set 0 to disable limit. Leave blank to set it to user selected.</div>
                </div>
                <!-- Checkbox for EnableBackdropsByDefault -->
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="EnableBackdropsByDefault" is="emby-checkbox" name="EnableBackdropsByDefault" type="checkbox"/>
                        <span>Enable Backdrops by default</span>
                    </label>
                     <div class="fieldDescription">Display the backdrops in the background of some pages while browsing the library by default for all users</div>
                </div>
                <!-- Checkbox for EnableDetailsBannerByDefault -->
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="EnableDetailsBannerByDefault" is="emby-checkbox" name="EnableDetailsBannerByDefault" type="checkbox"/>
                        <span>Enable Details Banner by default</span>
                    </label>
                     <div class="fieldDescription">Display a banner image at the top of the item details page for all users</div>
                </div>
                <!-- Checkbox for ForceEnableThemeMusic -->
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="ForceEnableThemeMusic" is="emby-checkbox" name="ForceEnableThemeMusic" type="checkbox"/>
                        <span>Force enable "Theme Songs" for all users</span>
                    </label>
                    <div class="fieldDescription">Override the setting to Play the theme songs in background while browsing the library for all users</div>
                </div>
                <!-- Checkbox for ForceEnableThemeVideos -->
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="ForceEnableThemeVideos" is="emby-checkbox" name="ForceEnableThemeVideos" type="checkbox"/>
                        <span>Force enable "Theme Videos" for all users</span>
                    </label>
                    <div class="fieldDescription">Override the setting to Play theme videos in the background while browsing the library for all users.</div>
                </div>
                <!-- Checkbox for ForceDisableNextVideoInfo -->
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="ForceDisableNextVideoInfo" is="emby-checkbox" name="ForceDisableNextVideoInfo" type="checkbox"/>
                        <span>Force disable "Show next video info during playback" for all users</span>
                    </label>
                     <div class="fieldDescription">At the end of a video, display info about the next video coming up in the current playlist.</div>
                </div>
                <!-- Checkbox for ForceEnableRewatchingInNextUp -->
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="ForceEnableRewatchingInNextUp" is="emby-checkbox" name="ForceEnableRewatchingInNextUp" type="checkbox"/>
                        <span>Force enable "Rewatching in Next Up"</span>
                    </label>
                    <div class="fieldDescription">Override the setting to enable showing already watched episodes in 'Next Up' sections all users.</div>
                </div>
                <!-- Checkbox for ForceEnableEpisodeImagesInNextUp -->
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="ForceEnableEpisodeImagesInNextUp" is="emby-checkbox" name="ForceEnableEpisodeImagesInNextUp" type="checkbox"/>
                        <span>Force enable "Use episode images in 'Next Up' and 'Continue Watching' sections"</span>
                    </label>
                    <div class="fieldDescription">'Next Up' and 'Continue Watching' sections will use episode images as thumbnails instead of the primary thumbnail of the show for all users</div>
                </div>

                <hr style="margin: 2em 0;"/>
                <h3>Display and Video Settings</h3>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="DisplayMode">Display Mode</label>
                    <select id="DisplayMode" is="emby-select" name="DisplayMode">
                        <option value="">Auto</option>
                        <option value="experimental">Experimental</option>
                    </select>
                    <div class="fieldDescription">Set the display mode for the interface</div>
                </div>

                <div class="inputContainer">
                    <label class="inputLabel inputLabelUnfocused" for="MaxVideoWidth">Maximum Allowed Video Transcoding Resolution</label>
                    <select id="MaxVideoWidth" is="emby-select" name="MaxVideoWidth">
                        <option value="0">Auto</option>
                        <option value="-1">Screen Resolution</option>
                        <option value="640">360p</option>
                        <option value="852">480p</option>
                        <option value="1280">720p</option>
                        <option value="1920">1080p</option>
                        <option value="3840">4K</option>
                        <option value="7680">8K</option>
                    </select>
                    <div class="fieldDescription">Set the maximum resolution for video transcoding</div>
                </div>

                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="LimitSupportedVideoResolution" is="emby-checkbox" name="LimitSupportedVideoResolution" type="checkbox"/>
                        <span>Limit maximum supported video resolution</span>
                    </label>
                    <div class="fieldDescription">Use 'Maximum Allowed Video Transcoding Resolution' as maximum supported video resolution</div>
                </div>

                <br/>
                <div
                    style="background-color: rgba(255, 255, 255, 0.05); border-left: 4px solid #00a4dc; border-radius: 4px; padding: 1em 1.5em; margin: 1.5em 0; display: flex; align-items: center; gap: 1em;">
                    <i class="material-icons" style="color: #00a4dc; font-size: 24px;">info</i>
                    <div>
                        All changes require a page refresh to take effect. <br/>
                        If old settings persist, please force clear browser cache.
                    </div>
                </div>
                <div>
                    <button class="raised button-submit block emby-button" is="emby-button" type="submit">
                        <span>Save</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
<script type="text/javascript">
        (() => {
            const pluginId = 'dfee3828-01df-49df-85b1-5c2b75e5ea1a';
            const page = document.querySelector('#JellyTweaksPage');
            const form = document.querySelector('#JellyTweaksForm');

            // Function to load the configuration from the server
            function loadConfig() {
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(pluginId).then((config) => {
                    // Populate form fields with the loaded configuration
                    document.querySelector('#DefaultLibraryPageSize').value = config.DefaultLibraryPageSize;
                    document.querySelector('#MaxDaysNextUp').value = config.MaxDaysNextUp ?? '';
                    document.querySelector('#EnableBackdropsByDefault').checked = config.EnableBackdropsByDefault;
                    document.querySelector('#EnableDetailsBannerByDefault').checked = config.EnableDetailsBannerByDefault;
                    document.querySelector('#ForceEnableThemeMusic').checked = config.ForceEnableThemeMusic;
                    document.querySelector('#ForceEnableThemeVideos').checked = config.ForceEnableThemeVideos;
                    document.querySelector('#ForceDisableNextVideoInfo').checked = config.ForceDisableNextVideoInfo;
                    document.querySelector('#ForceEnableRewatchingInNextUp').checked = config.ForceEnableRewatchingInNextUp;
                    document.querySelector('#ForceEnableEpisodeImagesInNextUp').checked = config.ForceEnableEpisodeImagesInNextUp;
                    document.querySelector('#DisplayMode').value = config.DisplayMode || '';
                    document.querySelector('#MaxVideoWidth').value = config.MaxVideoWidth || 0;
                    document.querySelector('#LimitSupportedVideoResolution').checked = config.LimitSupportedVideoResolution;
                    Dashboard.hideLoadingMsg();
                });
            }

            // Function to save the configuration
            function saveConfig(e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                // Build the configuration object from the form fields
                const config = {
                    DefaultLibraryPageSize: parseInt(document.querySelector('#DefaultLibraryPageSize').value, 10) || 0,
                    MaxDaysNextUp: document.querySelector('#MaxDaysNextUp').value === '' ? null : parseInt(document.querySelector('#MaxDaysNextUp').value, 10),
                    EnableBackdropsByDefault: document.querySelector('#EnableBackdropsByDefault').checked,
                    EnableDetailsBannerByDefault: document.querySelector('#EnableDetailsBannerByDefault').checked,
                    ForceEnableThemeMusic: document.querySelector('#ForceEnableThemeMusic').checked,
                    ForceEnableThemeVideos: document.querySelector('#ForceEnableThemeVideos').checked,
                    ForceDisableNextVideoInfo: document.querySelector('#ForceDisableNextVideoInfo').checked,
                    ForceEnableRewatchingInNextUp: document.querySelector('#ForceEnableRewatchingInNextUp').checked,
                    ForceEnableEpisodeImagesInNextUp: document.querySelector('#ForceEnableEpisodeImagesInNextUp').checked,
                    DisplayMode: document.querySelector('#DisplayMode').value || '',
                    MaxVideoWidth: parseInt(document.querySelector('#MaxVideoWidth').value, 10) || 0,
                    LimitSupportedVideoResolution: document.querySelector('#LimitSupportedVideoResolution').checked
                };

                // Update the plugin configuration on the server
                ApiClient.updatePluginConfiguration(pluginId, config)
                    .then((result) => {
                        Dashboard.processPluginConfigurationUpdateResult(result);
                    })
                    .catch(() => {
                        Dashboard.hideLoadingMsg(); // Ensure loading message is hidden on error
                    });

                return false;
            }

            // Attach event listeners
            page.addEventListener('pageshow', loadConfig);
            form.addEventListener('submit', saveConfig);

        })();
    </script>
</div>
</body>
</html>